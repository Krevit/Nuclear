{"version":3,"sources":["tag.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"tag.js","sourcesContent":["// Strict definitions\n;(function (window) {\n    'use strict';\n\n    // Tag field constructor\n    function Tag(el) {\n        this.el = el;\n\n        this._init();\n    }\n\n    // Tag prototype\n    Tag.prototype = {\n        // Initialize\n        _init: function () {\n            this.list = this.el.find('ul.taglist');\n            this.inputItem = this.el.find('div.tag-input');\n            this.input = this.inputItem.find('input[name=\"name\"]');\n            this.results = this.el.find('ul.form-items-list-results');\n            this.parent = this.el.closest('.form-group');\n\n            this.urldetach = this.el.data('urldetach');\n            this.urladd = this.el.data('urladd');\n            this.urlsearch = this.el.data('urlsearch');\n\n            this.tags = [];\n            this.tempTags = [];\n\n            this.searching = false;\n\n            this._parseExistingTags();\n\n            this._initEvents();\n        },\n        _parseExistingTags: function () {\n            var tags = this.list.find('.tag'),\n                self = this;\n\n            tags.each(function () {\n                var el = $(this);\n\n                self._addToTagList(\n                    el.data('id'),\n                    el.find('span').text().toLowerCase()\n                );\n            });\n        },\n        _addToTagList: function (id, name) {\n            this.tags[id] = name;\n        },\n        // Initialize events\n        _initEvents: function () {\n            var self = this;\n\n            this.input.bind('keydown', function (e) {\n                var input = $(this),\n                    val = input.val().trim();\n\n                if (e.which === 27) {\n                    e.stopPropagation();\n\n                    if (val === '') {\n                        input.blur();\n                    } else {\n                        input.val('');\n                    }\n\n                    self._clearSearch();\n\n                    // This blurs field, no need to go further\n                    return;\n                } else if (e.which === 9 || e.which === 13) {\n                    e.preventDefault();\n\n                    if (val !== '') {\n                        self._addTag(val);\n                        input.val('');\n                    }\n\n                    // This adds an item, no need to go further\n                    return;\n                }\n\n                if (!self.searching && val.length > 0) {\n                    self._search(val);\n                }\n            });\n\n            // Remove buttons\n            this.list.on('click', '.icon-cancel', function () {\n                self._detachTag($(this));\n            });\n\n            this.results.on('click', 'li', function () {\n                self._addTag($(this).text());\n\n                self._clearSearch();\n            });\n\n            this.input.on('focus', function () {\n                self._showResults();\n            });\n\n            // Hiding search\n            $('body').click(function () {\n                self._hideResults();\n            });\n\n            this.parent.click(function (e) {\n                e.stopPropagation();\n            });\n        },\n        _detachTag: function (tag) {\n            var parent = tag.closest('.tag'),\n                id = parent.data('id');\n            // Quit if an action is already going on\n            if (parent.hasClass('disabled')) {\n                return;\n            }\n\n            parent.addClass('disabled');\n\n            var self = this;\n\n            $.ajax({\n                type: \"POST\",\n                url: self.urldetach,\n                data: {\n                    _method: \"DELETE\",\n                    tag: id\n                },\n                success: function (data) {\n                    self._removeTag(data.id);\n                },\n                error: function () {\n                    self._enableTag(id)\n                }\n            });\n        },\n        // Removes an item\n        _removeTag: function (id) {\n            var tag = this.list.find('li[data-id=\"' + id + '\"]');\n            delete this.tags[id];\n            tag.remove();\n            this._setListClass();\n        },\n        // Removes a temporary item\n        _removeTempTag: function (id) {\n            var tag = this.list.find('li[data-tempid=\"' + id + '\"]');\n            delete this.tempTags[id];\n            tag.remove();\n            this._setListClass();\n        },\n        _enableTag: function (id) {\n            this.list.find('li[data-id=\"' + id + '\"]').removeClass('disabled');\n        },\n        _enableTempTag: function (tempid, id) {\n            var tag = this.list.find('li[data-tempid=\"' + tempid + '\"]');\n            tag.removeClass('disabled');\n            tag.removeData('tempid');\n            tag.attr({'data-id': id});\n        },\n        // Adds an item\n        _addTag: function (str) {\n            var i = this.tags.indexOf(str.toLowerCase());\n\n            if (i > -1) {\n                this._flashTag(i);\n            } else {\n                this.tempTags.push(str);\n                i = this.tempTags.indexOf(str);\n                this._createTag(i, str);\n\n                this._linkTag(i, str);\n\n                this._setListClass();\n\n                this._clearSearch();\n            }\n        },\n        _linkTag: function (i, str) {\n            var self = this;\n\n            $.ajax({\n                type: \"POST\",\n                url: self.urladd,\n                data: {\n                    _method: \"PUT\",\n                    name: str\n                },\n                success: function (data) {\n                    if (!self._tagExists(data.id)) {\n                        self._enableTempTag(i, data.id);\n                        self._addToTagList(data.id, data.name);\n                        delete self.tempTags[i];\n                    } else {\n                        self._removeTempTag(i);\n                        self._flashTag(data.id);\n                    }\n\n                    self._clearSearch();\n\n                    self._setListClass();\n                },\n                error: function () {\n                    self._removeTempTag(i);\n\n                    self._setListClass();\n                }\n            });\n        },\n        _tagExists: function (id) {\n            return (typeof this.tags[id] != 'undefined') ? true : false;\n        },\n        // Creates a tag and appends to list\n        _createTag: function (id, str) {\n            $('<li class=\"tag disabled\" data-id=\"\" data-tempid=\"' + id + '\">' + html_entities(str) + '<i class=\"icon-cancel\"></i></li>').appendTo(this.list);\n        },\n        // Flashes a tag\n        _flashTag: function (id) {\n            var duplicate = this.list.find('li[data-id=\"' + id + '\"]');\n\n            duplicate.addClass('flash');\n\n            setTimeout(function () {\n                duplicate.removeClass('flash');\n            }, 100);\n        },\n        // Sets the list class\n        _setListClass: function () {\n            if (count(this.tags) == 0) {\n                this.list.addClass('empty');\n            } else {\n                this.list.removeClass('empty');\n            }\n        },\n        // Search for tags\n        _search: function (keywords) {\n            var self = this;\n\n            if(!self.searching) {\n                $.post(this.urlsearch, {q: keywords}, function (data) {\n                    self._populateResults(data);\n                });\n            }\n        },\n        // Populate the results list\n        _populateResults: function (tags) {\n            // Do not populate if empty\n            // This is to prevent the results table reappearing after enter is pressed\n            if(this.input.val().trim() == '')\n            {\n                return;\n            }\n\n            this.results.empty();\n\n            for (var key in tags) {\n                if (!this._tagExists(key)) {\n                    var item = this._createListItem(key, tags[key]);\n\n                    this.results.append(item);\n                }\n            }\n        },\n        // Creates an item in the results list\n        _createListItem: function (id, name) {\n            return $('<li data-id=\"' + id + '\">' + name + '</li>');\n        },\n        _showResults: function () {\n            this.results.removeClass('hidden');\n        },\n        _hideResults: function () {\n            this.results.addClass('hidden');\n        },\n        _clearSearch: function () {\n            this.results.empty();\n            this.input.val('');\n        },\n    };\n\n    // Register to window namespace\n    window.Tag = Tag;\n\n})(window);\n\n// Tag fields\n$('.form-group-tag').each(function () {\n    new Tag($(this));\n});\n\n$('.form-group input').focus(function () {\n    $(this).closest('.form-group').addClass('focus');\n});\n$('.form-group input').blur(function () {\n    $(this).closest('.form-group').removeClass('focus');\n});"],"sourceRoot":"/source/"}