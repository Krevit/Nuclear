!function(t){"use strict";function s(t){this.el=t,this._init()}s.prototype={_init:function(){this.list=this.el.find("ul.taglist"),this.inputItem=this.el.find("div.tag-input"),this.input=this.inputItem.find('input[name="name"]'),this.results=this.el.find("ul.form-items-list-results"),this.parent=this.el.closest(".form-group"),this.urlunlink=this.el.data("urlunlink"),this.urladd=this.el.data("urladd"),this.urlsearch=this.el.data("urlsearch"),this.tags=[],this.tempTags=[],this.searchCountdown=null,this._parseExistingTags(),this._initEvents()},_parseExistingTags:function(){var t=this.list.find(".tag"),s=this;t.each(function(){var t=$(this);s._addToTagList(t.data("id"),t.find("span").text().toLowerCase())})},_addToTagList:function(t,s){this.tags[t]=s},_initEvents:function(){var t=this;this.input.bind("keydown",function(s){var i=$(this),a=i.val().trim();27===s.which?(s.stopPropagation(),""===a?i.blur():i.val("")):(9===s.which||13===s.which)&&(s.preventDefault(),""!==a&&(t._addTag(a),i.val(""))),null===t.searchCountdown&&a.length>0&&t._search(a,!0)}),this.list.on("click",".icon-cancel",function(){t._unlinkTag($(this))}),this.results.on("click","li",function(){t._addTag($(this).text()),t._clearSearch()}),this.input.on("focus",function(){t._showResults()}),$("body").click(function(){t._hideResults()}),this.parent.click(function(t){t.stopPropagation()})},_unlinkTag:function(t){var s=t.closest(".tag"),i=s.data("id");if(!s.hasClass("disabled")){s.addClass("disabled");var a=this;$.ajax({type:"POST",url:a.urlunlink,data:{_method:"DELETE",tag:i},success:function(t){a._removeTag(t.id)},error:function(){a._enableTag(i)}})}},_removeTag:function(t){var s=this.list.find('li[data-id="'+t+'"]');delete this.tags[t],s.remove(),this._setListClass()},_removeTempTag:function(t){var s=this.list.find('li[data-tempid="'+t+'"]');delete this.tempTags[t],s.remove(),this._setListClass()},_enableTag:function(t){this.list.find('li[data-id="'+t+'"]').removeClass("disabled")},_enableTempTag:function(t,s){var i=this.list.find('li[data-tempid="'+t+'"]');i.removeClass("disabled"),i.removeData("tempid"),i.attr({"data-id":s})},_addTag:function(t){var s=this.tags.indexOf(t.toLowerCase());s>-1?this._flashTag(s):(this.tempTags.push(t),s=this.tempTags.indexOf(t),this._createTag(s,t),this._linkTag(s,t),this._setListClass())},_linkTag:function(t,s){var i=this;$.ajax({type:"POST",url:i.urladd,data:{_method:"PUT",name:s},success:function(s){i._tagExists(s.id)?(i._removeTempTag(t),i._flashTag(s.id)):(i._enableTempTag(t,s.id),i._addToTagList(s.id,s.name),delete i.tempTags[t]),i._setListClass()},error:function(){i._removeTempTag(t),i._setListClass()}})},_tagExists:function(t){return"undefined"!=typeof this.tags[t]?!0:!1},_createTag:function(t,s){$('<li class="tag disabled" data-id="" data-tempid="'+t+'">'+html_entities(s)+'<i class="icon-cancel"></i></li>').appendTo(this.list)},_flashTag:function(t){var s=this.list.find('li[data-id="'+t+'"]');s.addClass("flash"),setTimeout(function(){s.removeClass("flash")},100)},_setListClass:function(){0==count(this.tags)?this.list.addClass("empty"):this.list.removeClass("empty")},_search:function(t,s){var i=this;$.post(this.urlsearch,{q:t},function(t){i._populateResults(t)}),s&&this._setSearchCountdown(t)},_setSearchCountdown:function(t){var s=this;this.searchCountdown=setTimeout(function(){s.searchCountdown=null,s._search(t,!1)},1e3)},_populateResults:function(t){this.results.empty();for(var s in t)if(!this._tagExists(s)){var i=this._createListItem(s,t[s]);this.results.append(i)}},_createListItem:function(t,s){return $('<li data-id="'+t+'">'+s+"</li>")},_showResults:function(){this.results.removeClass("hidden")},_hideResults:function(){this.results.addClass("hidden")},_clearSearch:function(){this.results.empty(),this.input.val("")}},t.Tag=s}(window),$(".form-group-tag").each(function(){new Tag($(this))}),$(".form-group input").focus(function(){$(this).closest(".form-group").addClass("focus")}),$(".form-group input").blur(function(){$(this).closest(".form-group").removeClass("focus")});